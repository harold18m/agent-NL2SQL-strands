name: Build & Deploy Lambda (ECR image)

on:
  push:
    branches: [main]
    paths-ignore:
      - "terraform/**"
      - "*.md"
      - "docs/**"
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    env:
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies and run tests
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install --no-cache-dir mangum "fastapi[standard]" strands-agents[gemini] psycopg2-binary python-dotenv strands-agents-tools requests pytest
          pytest -q --tb=short

      - name: Build and push image to ECR
        env:
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGION=${{ secrets.AWS_REGION }}
          IMAGE_URI="${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${ECR_REPOSITORY}:${IMAGE_TAG}"

          echo "ðŸ”¨ Building image: ${IMAGE_URI}"
          docker build -t "${IMAGE_URI}" -f Dockerfile.lambda .

          # Also tag as latest
          docker tag "${IMAGE_URI}" "${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${ECR_REPOSITORY}:latest"

          echo "ðŸ“¤ Pushing images to ECR..."
          docker push "${IMAGE_URI}"
          docker push "${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${ECR_REPOSITORY}:latest"

          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV

      - name: Update Lambda function
        env:
          LAMBDA_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
        run: |
          echo "ðŸš€ Updating Lambda function: ${LAMBDA_NAME}"
          aws lambda update-function-code \
            --function-name "${LAMBDA_NAME}" \
            --image-uri "${IMAGE_URI}"

      - name: Wait for Lambda update
        env:
          LAMBDA_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
        run: |
          echo "â³ Waiting for Lambda function update..."
          aws lambda wait function-updated --function-name "${LAMBDA_NAME}"
          echo "âœ… Lambda function updated successfully!"

      - name: Get Function URL and test health
        env:
          LAMBDA_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
        run: |
          FUNCTION_URL=$(aws lambda get-function-url-config --function-name "${LAMBDA_NAME}" --query 'FunctionUrl' --output text 2>/dev/null || echo "")

          if [ -n "${FUNCTION_URL}" ]; then
            echo "ðŸ”— Function URL: ${FUNCTION_URL}"
            echo "ðŸ¥ Testing health endpoint..."
            curl -s "${FUNCTION_URL}health" || echo "Health check pending (cold start)"
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Lambda Function | ${LAMBDA_NAME} |" >> $GITHUB_STEP_SUMMARY
            echo "| Image Tag | ${IMAGE_TAG} |" >> $GITHUB_STEP_SUMMARY
            echo "| Function URL | ${FUNCTION_URL} |" >> $GITHUB_STEP_SUMMARY
            echo "| Health Check | ${FUNCTION_URL}health |" >> $GITHUB_STEP_SUMMARY
          fi
